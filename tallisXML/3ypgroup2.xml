<?xml version="1.0" encoding="UTF-8"?>
<!-- This is a template mapping file for tallis-->

<!-- Leave this stuff. It tells the Enactment server to use a database connection '3yp-group2' that is already setup -->
<proformaDataMapping xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="proformaDataMapping.xsd">
<database id="3yp-group2">tallis</database>

<!-- treatment_status_READ: Current number of drugs the patient is on & BP Flag status. Table: patientDrugs & patientInfo -->
<enquiryReader taskName="Current_treatment_READ" dataItem="Number_of_drugs">
<preparedSQLStatement dbName="tallis" params="patientID">
SELECT numberDrugs FROM patientDrugs WHERE patientID=(?)
</preparedSQLStatement>
</enquiryReader>

<enquiryReader taskName="Current_treatment_READ" dataItem="BPcontrolled">
<preparedSQLStatement dbName="tallis" params="patientID">
SELECT BPFlag FROM patientInfo WHERE patientID=(?)
</preparedSQLStatement>
</enquiryReader>

<!-- treatment_status_READ: Get Drug 1 info. Table: patientDrugs-->
<enquiryReader taskName="Drug1_READ" dataItem="Drug1">
<preparedSQLStatement dbName="tallis" params="patientID">
SELECT drug1 FROM patientDrugs WHERE patientID=(?)
</preparedSQLStatement>
</enquiryReader>

<enquiryReader taskName="Drug1_READ" dataItem="Drug1Prescription">
<preparedSQLStatement dbName="tallis" params="patientID">
SELECT drug1prescription FROM patientDrugs WHERE patientID=(?)
</preparedSQLStatement>
</enquiryReader>

<enquiryReader taskName="Drug1_READ" dataItem="Drug1class">
<preparedSQLStatement dbName="tallis" params="patientID">
SELECT drug1class FROM patientDrugs WHERE patientID=(?)
</preparedSQLStatement>
</enquiryReader>

<!-- treatment_status_READ: Get Drug 2 info. Table: patientDrugs-->
<enquiryReader taskName="Drug2_READ" dataItem="Drug2">
<preparedSQLStatement dbName="tallis" params="patientID">
SELECT drug2 FROM patientDrugs WHERE patientID=(?)
</preparedSQLStatement>
</enquiryReader>

<enquiryReader taskName="Drug2_READ" dataItem="Drug2Prescription">
<preparedSQLStatement dbName="tallis" params="patientID">
SELECT drug2prescription FROM patientDrugs WHERE patientID=(?)
</preparedSQLStatement>
</enquiryReader>

<enquiryReader taskName="Drug2_READ" dataItem="Drug2class">
<preparedSQLStatement dbName="tallis" params="patientID">
SELECT drug2class FROM patientDrugs WHERE patientID=(?)
</preparedSQLStatement>
</enquiryReader>

<!-- treatment_status_READ: Get Drug 3 info. Table: patientDrugs-->
<enquiryReader taskName="Drug3_READ" dataItem="Drug3">
<preparedSQLStatement dbName="tallis" params="patientID">
SELECT drug3 FROM patientDrugs WHERE patientID=(?)
</preparedSQLStatement>
</enquiryReader>

<enquiryReader taskName="Drug3_READ" dataItem="Drug3Prescription">
<preparedSQLStatement dbName="tallis" params="patientID">
SELECT drug3prescription FROM patientDrugs WHERE patientID=(?)
</preparedSQLStatement>
</enquiryReader>

<enquiryReader taskName="Drug3_READ" dataItem="Drug3class">
<preparedSQLStatement dbName="tallis" params="patientID">
SELECT drug3class FROM patientDrugs WHERE patientID=(?)
</preparedSQLStatement>
</enquiryReader>

<!-- treatment_status_READ: Get Drug 4 info. Table: patientDrugs-->
<enquiryReader taskName="Drug4_READ" dataItem="Drug4">
<preparedSQLStatement dbName="tallis" params="patientID">
SELECT drug4 FROM patientDrugs WHERE patientID=(?)
</preparedSQLStatement>
</enquiryReader>

<enquiryReader taskName="Drug4_READ" dataItem="Drug4Prescription">
<preparedSQLStatement dbName="tallis" params="patientID">
SELECT drug4prescription FROM patientDrugs WHERE patientID=(?)
</preparedSQLStatement>
</enquiryReader>

<enquiryReader taskName="Drug4_READ" dataItem="Drug4class">
<preparedSQLStatement dbName="tallis" params="patientID">
SELECT drug4class FROM patientDrugs WHERE patientID=(?)
</preparedSQLStatement>
</enquiryReader>

<!-- treatment_status_READ: Get MaxDose yes/no from Drug 1. Table: drugList-->
<enquiryReader taskName="max_dosage_1" dataItem="Max_dosage">
<preparedSQLStatement dbName="tallis" params="Drug1 Drug1Prescription Drug1 Drug1Prescription">
SELECT * FROM   (
		SELECT 
		    CASE 
			WHEN drugList.drug = (?) AND drugList.maxDose > (?) THEN 'No'
			WHEN drugList.drug = (?) AND (?) >= drugList.maxDose  THEN 'Yes'
		    END AS result
                FROM drugList
		)
AS result
WHERE result IS NOT NULL
</preparedSQLStatement>
</enquiryReader>

<!-- The Writer tasks operate on an Enquiry, a decision, or an action box. Notice that the params="patientID patientName symptoms" exactly
matches the variable names used in Tallis itself. These are then placed into the SQL statement instead of '?'. Note it does this in the
same order that params are listed. -->
<enquiryWriter taskName="get_symptoms">
<preparedSQLStatement dbName="tallis" params="patientID patientsName symptoms">
INSERT INTO PATIENT_DATA (PATIENT_ID, NAME, SYMPTOMS) VALUES (?, ?, ?)
</preparedSQLStatement>
</enquiryWriter>

<decisionWriter taskName="diagnosis">
<preparedSQLStatement dbName="tallis" params="patientID DECISION_NAME TIME_STAMP RECOMMENDATIONS SELECTION">
INSERT INTO DECISIONS (PATIENT_ID, DECISION_NAME, TIME_STAMP, RECOMMENDATIONS, SELECTION) VALUES (?, ?, ?, ?, ?)
</preparedSQLStatement>
</decisionWriter>

<actionWriter taskName="prescribe_painkillers">
<preparedSQLStatement dbName="tallis" params="patientID">
UPDATE PATIENT_DATA SET PILL_TAKER = TRUE WHERE PATIENT_ID = (?)
</preparedSQLStatement>
</actionWriter>
</proformaDataMapping>